<!doctype html>
<html lang="en">

<head>
  <link rel="icon"
    href="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3,9H7V5H3V9M3,14H7V10H3V14M8,14H12V10H8V14M13,14H17V10H13V14M8,9H12V5H8V9M13,5V9H17V5H13M18,14H22V10H18V14M3,19H7V15H3V19M8,19H12V15H8V19M13,19H17V15H13V19M18,19H22V15H18V19M18,5V9H22V5H18Z'/%3E%3C/svg%3E"
    type="image/svg+xml" />
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <title>Wled-pixel</title>
</head>

<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <header>
    <div class="px-3 py-2 bg-dark text-white">
      <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
          <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none">
            <h1 class="mb-3 fw-bold font-monospace">wledPixel</h1>
          </a>

          <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small">
            <li>
              <a href="/" class="nav-link text-white">
                Home
              </a>
            </li>
            <li>
              <a href="/zone-settings" class="nav-link text-white">
                Zone Settings
              </a>
            </li>
            <li>
              <span class="nav-link text-secondary">
                Service Settings
              </span>
            </li>
            <li>
              <a href="/backup" class="nav-link text-white">
                Backup/Restore
              </a>
            </li>
            <li>
              <a href="/update" class="nav-link text-white">
                Update firmware
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </header>
  <div class="container">
    <main>
      <div class="py-5 text-center">
        <h2>Service Settings</h2>
        <p class="lead">Configure system parameters and external integrations (MQTT, Home Assistant, OpenWeatherMap,
          NTP).</p>
      </div>
      <div class="row g-5">
        <div class="col-md-5 col-lg-4 order-md-last">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-primary">Info</span>
          </h4>
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">wledPixel</h6>
                <small class="text-muted">wledPixel dot led Display</small>
              </div>
              <span class="text-muted" id="firmwareVer"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">Platform:</h6>
              </div>
              <span class="text-muted" id="platform"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">Wifi SSID:</h6>
              </div>
              <span class="text-muted" id="wifiSsid"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">Wifi IP:</h6>
              </div>
              <span class="text-muted" id="wifiIp"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">Wifi Gateway:</h6>
              </div>
              <span class="text-muted" id="wifiGateway"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">Wifi Signal:</h6>
              </div>
              <span class="text-muted" id="wifiRssi"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">MQTT device prefix:</h6>
              </div>
              <span class="text-muted" id="mqttDevicePrefixInfo"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-sm">
              <div>
                <h6 class="my-0">ds18b20 Temperature:</h6>
              </div>
              <span class="text-muted" id="ds18b20TempInfo"></span>
            </li>
          </ul>

          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-primary">Help</span>
          </h4>
          <div>
            <h6 class="my-2">Font</h6>
            <small class="text-muted"><b>Cyrillic</b> - compact neat font<br><b>Wled</b> - fundamental
              font<br><b>Default</b> - standard display library font</small>
          </div>
          <hr>
          <div>
            <h6 class="my-2">Character spacing</h6>
            <small class="text-muted">Distance between characters on the display. The default is exactly 1. It is useful
              to set 0 if you need to fit a lot of text on the display or you can use the Cyrillic font.</small>
          </div>
          <hr>
          <div>
            <h6 class="my-2">Wall clock</h6>
            <small class="text-muted">Clock mode. It has the following display options:
              <br><b>HH:MM</b> - Hours : Minutes [21:43]
              <br><b>HH:MM:SS</b> - Hours : Minutes : Seconds [21:43:54]
              <br><b>HH</b> - Hours [21]
              <br><b>MM</b> - Minutes [43]
              <br><b>dd.mm.yyyy</b> - Day.Month.Year [21.06.2022]
              <br><b>dd.mm</b> - Day.Month [21.06]
              <br><b>dd.mm aa</b> - Day.Month weekday name (e.g., Sun) [21.06 Tue] <b>*</b><i>in Cyrillic font weekday
                name will be in Cyrillic</i>
              <br><br><b>Advice</b><br>In <b>HH:MM</b> and <b>HH:MM:SS</b> mode, two dots flash every second. For
              correct operation, it is recommended to set the <b>effectIN</b> and <b>OUT</b> to the value
              <b>NO_EFFECT</b>.
            </small>
          </div>
          <hr>
          <div>
            <h6 class="my-2">Open Weather map</h6>
            <small class="text-muted">First, configure all the settings at the bottom of the page, and then turn on the
              work mode in the desired zone.
              <br><br>A free API token allows you to make requests no more than once every <b>60 seconds</b>! Otherwise,
              your token will be <b>blocked</b> for 24 hours.
              <br><br>Each zone makes its own request to the API, consider this when calculating the update interval (2
              zones - 120 seconds, etc.)</small>
          </div>
          <hr>
          <div>
            <h6 class="my-2">Home Assistant client</h6>
            <small class="text-muted">Use a <a href="https://www.home-assistant.io/docs/authentication/">Long-lived
                access token</a>.
              <br><br>Only display of sensor value is supported.
              <br><br>Sensor ID copy from your Home Assistant (e.g. sensor.lumi_weather)</small>
          </div>
          <hr>
          <div>
            <h6 class="my-2">MQTT client</h6>
            <small class="text-muted">The following topics are supported:
              <ul>
                <li><b>devicePrefix/zone<i>N</i>/workmode</b> - zone work mode</li>
                <ul>
                  <li>mqttClient</li>
                  <li>manualInput</li>
                  <li>wallClock</li>
                  <li>owmWeather</li>
                  <li>haClient</li>
                  <li>intTempSensor (DS18B20)</li>
                  <li>wopr (WarGames effect)</li>
                  <li>stockTicker</li>
                </ul>
                <li><b>devicePrefix/zone<i>N</i>/text</b> - text to display (for mqttClient mode)</li>
                <li><b>devicePrefix/zone<i>N</i>/scrolleffectIn</b> - scroll effect <b>IN</b></li>
                <li><b>devicePrefix/zone<i>N</i>/scrolleffectOut</b> - scroll effect <b>Out</b></li><br>
                <b>scrolleffectIn</b> and <b>scrolleffectOut</b> support next values:
                <ul>
                  <li>PA_NO_EFFECT</li>
                  <li>PA_SCROLL_UP</li>
                  <li>PA_SCROLL_DOWN</li>
                  <li>PA_SCROLL_LEFT</li>
                  <li>PA_SCROLL_RIGHT</li>
                  <li>PA_SLICE</li>
                  <li>PA_MESH</li>
                  <li>PA_FADE</li>
                  <li>PA_DISSOLVE</li>
                  <li>PA_BLINDS</li>
                  <li>PA_RANDOM</li>
                  <li>PA_WIPE</li>
                  <li>PA_WIPE_CURSOR</li>
                  <li>PA_SCAN_HORIZ</li>
                  <li>PA_SCAN_VERT</li>
                  <li>PA_OPENING</li>
                  <li>PA_OPENING_CURSOR</li>
                  <li>PA_CLOSING</li>
                  <li>PA_CLOSING_CURSOR</li>
                  <li>PA_SCROLL_UP_LEFT</li>
                  <li>PA_SCROLL_UP_RIGHT</li>
                  <li>PA_SCROLL_DOWN_LEFT</li>
                  <li>PA_SCROLL_DOWN_RIGHT</li>
                  <li>PA_GROW_UP</li>
                  <li>PA_GROW_DOWN</li>
                </ul><br>
                <li><b>devicePrefix/zone<i>N</i>/scrollspeed</b> - scroll speed</li>
                <li><b>devicePrefix/zone<i>N</i>/scrollpause</b> - scroll pause</li>
                <li><b>devicePrefix/zone<i>N</i>/scrollalign</b> - scroll alignment</li>
                <li><b>devicePrefix/zone<i>N</i>/charspacing</b> - character spacing</li>
                <li><b>devicePrefix/intensity</b> - brightness</li>
                <li><b>devicePrefix/zone<i>N</i>/scrollInfinite</b> - infinite scroll (on/off)</li>
                <li><b>devicePrefix/zone<i>N</i>/workmode</b> - zone work mode</li>
                <li><b>devicePrefix/power</b> - display power control, support <b>on</b> / <b>off</b> values</li>
              </ul>
              where <b>devicePrefix</b> = <span id="mqttDevicePrefixHelp"></span>
              <br><b>zoneN</b> = zone number (e.g. Zone0, Zone1, Zone2, Zone3)
            </small>
          </div>
          <hr>
          <div>
            <h6 class="my-2">HTTP API</h6>
            <small class="text-muted">
              <b>Manual Message:</b><br>
              POST to <b>/api/message</b> with parameters:
              <ul>
                <li><b>messageZone0</b> ... <b>messageZone3</b> - Text to display</li>
              </ul>
              Sending the same message again will restart the animation immediately.
            </small>
          </div>

        </div>
        <div class="col-md-7 col-lg-8">
          <form class="needs-validation" novalidate="">
            <div class="row g-3">

              <h3 class="mb-3">System settings</h3>
              <div class="col-6" hidden>
                <label for="deviceName" class="form-label">Device Name</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="deviceName">
                </div>
              </div>

              <div class="col-6 align-self-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="disableServiceMessages"
                    id="disableServiceMessages">
                  <label class="form-check-label" for="disableServiceMessages">
                    Disable service messages on display
                  </label>
                </div>
              </div>
              <div class="row">
                <div class="col-6">
                  <button id="applySystemSettings" class="w-100 btn btn-primary btn-lg"
                    onClick="preparePostRequest(event, this.id, null);">Apply</button>
                </div>
                <div class="col-6">
                  <button type="button" id="rebootDevice" class="w-100 btn btn-danger btn-lg"
                    onClick="apiRebootDevice();">Reboot Device</button>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <button type="button" id="resetWifi" class="w-100 btn btn-warning btn-lg"
                    onClick="apiResetWifi();">Reset WiFi Settings</button>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <button type="button" id="factoryReset" class="w-100 btn btn-dark btn-lg"
                    onClick="apiFactoryReset();">Factory Reset (Erase All Settings)</button>
                </div>
              </div>

              <hr class="my-4">

              <h3 class="mb-3">MQTT settings</h3>

              <div class="col-12 align-self-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="mqttEnable" id="mqttEnable">
                  <label class="form-check-label" for="mqttEnable">
                    Enable MQTT
                  </label>
                </div>
              </div>

              <div class="col-6">
                <label for="mqttServerAddress" class="form-label">Server address</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="mqttServerAddress">
                </div>
              </div>

              <div class="col-6">
                <label for="mqttServerPort" class="form-label">Server port</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="mqttServerPort">
                </div>
              </div>

              <div class="col-6">
                <label for="mqttUsername" class="form-label">Username</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="mqttUsername">
                </div>
              </div>

              <div class="col-6">
                <label for="mqttPassword" class="form-label">Password</label>
                <div class="input-group mb-3">
                  <input type="password" class="form-control" id="mqttPassword">
                </div>
              </div>

              <button id="applyMqttSettings" class="w-100 btn btn-primary btn-lg"
                onClick="preparePostRequest(event, this.id, null);">Apply</button>


              <hr class="my-4">
              <h3 class="mb-3">Wall clock settings</h3>
              <div class="col-6">
                <label class="form-label">NTP Time server</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="ntpServer">
                </div>
              </div>
              <div class="col-3">
                <label for="ntpTimeZone" class="form-label">Time zone</label>
                <div class="input-group mb-3">
                  <span class="input-group-text">UTC</span>
                  <input type="number" step="0.25" class="form-control" id="ntpTimeZone">
                </div>
              </div>
              <div class="col-3">
                <label for="timeZone" class="form-label">Update interval</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="ntpUpdateInterval">
                  <span class="input-group-text">Hours</span>
                </div>
              </div>
              <div class="col-12 align-self-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="disableDotsblink" id="disableDotsBlink">
                  <label class="form-check-label" for="disableDotsBlink">
                    Disable clock dots blink
                  </label>
                </div>
              </div>


              <button id="applyWallClockSettings" class="w-100 btn btn-primary btn-lg"
                onClick="preparePostRequest(event, this.id, null);">Apply</button>


              <hr class="my-4">
              <h3 class="mb-4">Open Weather map settings</h3>
              <div class="col-6">
                <label for="owmCity" class="form-label">City <small>Name</small></label>
                <div class="input-group mb-4">
                  <input type="text" class="form-control" id="owmCity">
                </div>
              </div>
              <div class="col-6">
                <label for="owmApiToken" class="form-label">API token</label>
                <div class="input-group mb-4">
                  <input type="password" class="form-control" id="owmApiToken">
                </div>
              </div>

              <div class="col-6">
                <label class="form-label">Update interval</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="owmUpdateInterval">
                  <span class="input-group-text">s</span>
                </div>
              </div>
              <div class="col-6">
                <label for="clockDisplayFormat" class="form-label">Units format</label>
                <div class="input-group mb-3">
                  <select id="owmUnitsFormat" class="form-select">
                    <option value="metric">metric</option>
                    <option value="imperial">imperial</option>
                  </select>
                </div>
              </div>


              <button id="applyOwmSettings" class="w-100 btn btn-primary btn-lg"
                onClick="preparePostRequest(event, this.id, null);">Apply</button>


              <hr class="my-4">
              <h3 class="mb-4">Home Assistant client settings</h3>
              <div class="col-3">
                <label for="forhaApiHttpType" class="form-label">HTTP or HTTPS</label>
                <div class="input-group mb-3">
                  <select id="haApiHttpType" class="form-select">
                    <option value="http" selected="selected">HTTP</option>
                    <option value="https">HTTPS</option>
                  </select>
                </div>
              </div>
              <div class="col-6">
                <label for="haAddr" class="form-label">HA address</label><small class="form-text text-muted"> [without
                  HTTPS or HTTP or / ]</small>
                <div class="input-group mb-4">
                  <input type="text" class="form-control" id="haAddr">
                </div>
              </div>
              <div class="col-3">
                <label for="haApiPort" class="form-label">API port</label>
                <div class="input-group mb-4">
                  <input type="text" class="form-control" id="haApiPort">
                </div>
              </div>

              <div class="col-9">
                <label for="haApiToken" class="form-label">API token</label>
                <div class="input-group mb-4">
                  <input type="password" class="form-control" id="haApiToken">
                </div>
              </div>
              <div class="col-3">
                <label for="haUpdateInterval" class="form-label">Update interval</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="haUpdateInterval">
                  <span class="input-group-text">s</span>
                </div>
              </div>


              <button id="applyHaSettings" class="w-100 btn btn-primary btn-lg"
                onClick="preparePostRequest(event, this.id, null);">Apply</button>


              <hr class="my-4">
              <h3 class="mb-4">Internal Temperature sensor (ds18b20) settings</h3>
              <div class="col-6 align-self-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="ds18b20Enable" id="ds18b20Enable">
                  <label class="form-check-label" for="ds18b20Enable">
                    Enable Temperature sensor (ds18b20)
                  </label>
                </div>
              </div>
              <div class="col-6 align-self-center">
                <label for="haApiToken" class="form-label">Measured temperature: <span
                    id="ds18b20TempVal">Loading...</span></label>
              </div>
              <div class="col-6">
                <label class="form-label">Update interval</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="ds18b20UpdateInterval">
                  <span class="input-group-text">s</span>
                </div>
              </div>
              <div class="col-6">
                <label for="ds18b20UnitsFormat" class="form-label">Units format</label>
                <div class="input-group mb-3">
                  <select id="ds18b20UnitsFormat" class="form-select">
                    <option value="Celsius">Celsius</option>
                    <option value="Fahrenheit">Fahrenheit</option>
                  </select>
                </div>
              </div>
              <button id="applyDs18b20Settings" class="w-100 btn btn-primary btn-lg"
                onClick="preparePostRequest(event, this.id, null);">Apply</button>


              <hr class="my-4">
              <h3 class="mb-4">Stock Ticker settings</h3>
              <div class="col-12">
                <label for="stockApiToken" class="form-label">Finnhub API Token</label>
                <input type="text" class="form-control" id="stockApiToken">
              </div>
              <div class="col-6">
                <label class="form-label">Update interval</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="stockUpdateInterval">
                  <span class="input-group-text">s</span>
                </div>
              </div>
              <button id="applyStockSettings" class="w-100 btn btn-primary btn-lg"
                onClick="preparePostRequest(event, this.id, null);">Apply</button>



              <div class="col-sm-12"></div>
              <footer class="my-5 pt-5 text-muted text-center text-small border-top">
                <p class="mb-1">&copy; 2026 wledPixel <span id="footerFwVer"></span></p>
                <p class="mb-1">Developed by <a href="https://github.com/widapro"
                    class="text-reset text-decoration-none">widapro</a></p>
                <ul class="list-inline">
                  <li class="list-inline-item"><a href="https://github.com/widapro/wledPixel" target="_blank"
                      class="text-decoration-none">GitHub</a></li>
                  <li class="list-inline-item">|</li>
                  <li class="list-inline-item"><a href="https://github.com/widapro/wledPixel/issues" target="_blank"
                      class="text-decoration-none">Report Bug</a></li>
                </ul>
              </footer>
          </form>
        </div>
      </div>
    </main>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>



  <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">

    <div id="liveToastDanger" class="toast align-items-center text-white bg-danger border-0" role="alert"
      aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
      <div class="d-flex">
        <div class="toast-body">
          Error!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
    <div id="liveToastSuccess" class="toast align-items-center text-white bg-success border-0" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Success.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
    <div id="liveToastBusy" class="toast align-items-center text-white bg-warning border-0" role="alert"
      aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
      <div class="d-flex">
        <div class="toast-body">
          Device busy, retrying...
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>



  <script>
    function fetchWithRetry(url, options = {}, retries = 10, delayMs = 2000) {
      return fetch(url, options).then(res => {
        if (res.status === 503 && retries > 0) {
          console.log(`503 received, retrying in ${delayMs}ms...`);
          return new Promise(resolve => setTimeout(resolve, delayMs))
            .then(() => fetchWithRetry(url, options, retries - 1, delayMs));
        }
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      });
    }

    window.onload = function (e) {
      // Fetch settings from API
      fetchWithRetry('/api/service-settings')
        .then(data => {
          console.log('Settings loaded:', data);

          function setVal(id, val) {
            var el = document.getElementById(id);
            if (el) el.value = val;
          }
          function setChecked(id, val) {
            var el = document.getElementById(id);
            if (el) el.checked = val;
          }
          function setText(id, val) {
            var el = document.getElementById(id);
            if (el) el.innerText = val;
          }
          function setInner(id, val) {
            var el = document.getElementById(id);
            if (el) el.innerHTML = val;
          }


          // Populate fields
          setVal("workModeZone0", data.workModeZone0);
          setVal("workModeZone1", data.workModeZone1);
          setVal("workModeZone2", data.workModeZone2);
          setVal("workModeZone3", data.workModeZone3);
          setVal("zoneNumbers", data.zoneNumbers);
          setVal("zone0Begin", data.zone0Begin);
          setVal("zone0End", data.zone0End);
          setVal("zone1Begin", data.zone1Begin);
          setVal("zone1End", data.zone1End);
          setVal("zone2Begin", data.zone2Begin);
          setVal("zone2End", data.zone2End);
          setVal("zone3Begin", data.zone3Begin);
          setVal("zone3End", data.zone3End);
          setVal("intensity", data.intensity);
          setInner("intensityValue", data.intensity);
          setVal("scrollSpeedZone0", data.scrollSpeedZone0);
          setVal("scrollSpeedZone1", data.scrollSpeedZone1);
          setVal("scrollSpeedZone2", data.scrollSpeedZone2);
          setVal("scrollSpeedZone3", data.scrollSpeedZone3);
          setVal("scrollPauseZone0", data.scrollPauseZone0);
          setVal("scrollPauseZone1", data.scrollPauseZone1);
          setVal("scrollPauseZone2", data.scrollPauseZone2);
          setVal("scrollPauseZone3", data.scrollPauseZone3);
          setVal("scrollAlignZone0", data.scrollAlignZone0);
          setVal("scrollAlignZone1", data.scrollAlignZone1);
          setVal("scrollAlignZone2", data.scrollAlignZone2);
          setVal("scrollAlignZone3", data.scrollAlignZone3);
          setVal("scrollEffectZone0In", data.scrollEffectZone0In);
          setVal("scrollEffectZone0Out", data.scrollEffectZone0Out);
          setVal("scrollEffectZone1In", data.scrollEffectZone1In);
          setVal("scrollEffectZone1Out", data.scrollEffectZone1Out);
          setVal("scrollEffectZone2In", data.scrollEffectZone2In);
          setVal("scrollEffectZone2Out", data.scrollEffectZone2Out);
          setVal("scrollEffectZone3In", data.scrollEffectZone3In);
          setVal("scrollEffectZone3Out", data.scrollEffectZone3Out);

          setChecked("mqttEnable", data.mqttEnable);

          setVal("mqttServerAddress", data.mqttServerAddress);
          setVal("mqttServerPort", data.mqttServerPort);
          setVal("mqttUsername", data.mqttUsername);
          // Password is not sent back for security, or handle if needed
          setVal("mqttPassword", data.mqttPassword);

          setVal("mqttTextTopicZone0", data.mqttTextTopicZone0);
          setVal("mqttTextTopicZone1", data.mqttTextTopicZone1);
          setVal("mqttTextTopicZone2", data.mqttTextTopicZone2);
          setVal("mqttTextTopicZone3", data.mqttTextTopicZone3);
          setVal("ntpTimeZone", data.ntpTimeZone);
          setVal("ntpUpdateInterval", data.ntpUpdateInterval);
          setVal("ntpServer", data.ntpServer);
          setVal("clockDisplayFormatZone0", data.clockDisplayFormatZone0);
          setVal("clockDisplayFormatZone1", data.clockDisplayFormatZone1);
          setVal("clockDisplayFormatZone2", data.clockDisplayFormatZone2);
          setVal("clockDisplayFormatZone3", data.clockDisplayFormatZone3);
          setVal("owmWhatToDisplayZone0", data.owmWhatToDisplayZone0);
          setVal("owmWhatToDisplayZone1", data.owmWhatToDisplayZone1);
          setVal("owmWhatToDisplayZone2", data.owmWhatToDisplayZone2);
          setVal("owmWhatToDisplayZone3", data.owmWhatToDisplayZone3);
          setVal("owmApiToken", data.owmApiToken);
          setVal("owmUnitsFormat", data.owmUnitsFormat);
          setVal("owmUpdateInterval", data.owmUpdateInterval);
          setVal("owmCity", data.owmCity);
          setVal("fontZone0", data.fontZone0);
          setVal("fontZone1", data.fontZone1);
          setVal("fontZone2", data.fontZone2);
          setVal("fontZone3", data.fontZone3);
          setVal("haAddr", data.haAddr);
          setVal("haApiHttpType", data.haApiHttpType);
          setVal("haApiToken", data.haApiToken);
          setVal("haApiPort", data.haApiPort);
          setVal("haUpdateInterval", data.haUpdateInterval);
          setVal("haSensorIdZone0", data.haSensorIdZone0);
          setVal("haSensorIdZone1", data.haSensorIdZone1);
          setVal("haSensorIdZone2", data.haSensorIdZone2);
          setVal("haSensorIdZone3", data.haSensorIdZone3);
          setVal("haSensorPostfixZone0", data.haSensorPostfixZone0);
          setVal("haSensorPostfixZone1", data.haSensorPostfixZone1);
          setVal("haSensorPostfixZone2", data.haSensorPostfixZone2);
          setVal("haSensorPostfixZone3", data.haSensorPostfixZone3);
          setVal("mqttPostfixZone0", data.mqttPostfixZone0);
          setVal("mqttPostfixZone1", data.mqttPostfixZone1);
          setVal("mqttPostfixZone2", data.mqttPostfixZone2);
          setVal("mqttPostfixZone3", data.mqttPostfixZone3);
          setChecked("scrollInfiniteZone0", data.scrollInfiniteZone0);
          setChecked("scrollInfiniteZone1", data.scrollInfiniteZone1);
          setChecked("scrollInfiniteZone2", data.scrollInfiniteZone2);
          setChecked("scrollInfiniteZone3", data.scrollInfiniteZone3);
          setVal("ds18b20PostfixZone0", data.ds18b20PostfixZone0);
          setVal("ds18b20PostfixZone1", data.ds18b20PostfixZone1);
          setVal("ds18b20PostfixZone2", data.ds18b20PostfixZone2);
          setVal("ds18b20PostfixZone3", data.ds18b20PostfixZone3);
          // Countdown settings
          if (data.countdownFormatZone0) setVal("countdownFormatZone0", data.countdownFormatZone0);
          if (data.countdownFormatZone1) setVal("countdownFormatZone1", data.countdownFormatZone1);
          if (data.countdownFormatZone2) setVal("countdownFormatZone2", data.countdownFormatZone2);
          if (data.countdownFormatZone3) setVal("countdownFormatZone3", data.countdownFormatZone3);
          if (data.countdownFinishZone0) setVal("countdownFinishZone0", data.countdownFinishZone0);
          if (data.countdownFinishZone1) setVal("countdownFinishZone1", data.countdownFinishZone1);
          if (data.countdownFinishZone2) setVal("countdownFinishZone2", data.countdownFinishZone2);
          if (data.countdownFinishZone3) setVal("countdownFinishZone3", data.countdownFinishZone3);
          if (data.countdownTargetZone0) setVal("countdownTargetZone0", data.countdownTargetZone0);
          if (data.countdownTargetZone1) setVal("countdownTargetZone1", data.countdownTargetZone1);
          if (data.countdownTargetZone2) setVal("countdownTargetZone2", data.countdownTargetZone2);
          if (data.countdownTargetZone3) setVal("countdownTargetZone3", data.countdownTargetZone3);
          if (data.countdownPrefixZone0) setVal("countdownPrefixZone0", data.countdownPrefixZone0);
          if (data.countdownPrefixZone1) setVal("countdownPrefixZone1", data.countdownPrefixZone1);
          if (data.countdownPrefixZone2) setVal("countdownPrefixZone2", data.countdownPrefixZone2);
          if (data.countdownPrefixZone3) setVal("countdownPrefixZone3", data.countdownPrefixZone3);
          if (data.countdownSuffixZone0) setVal("countdownSuffixZone0", data.countdownSuffixZone0);
          if (data.countdownSuffixZone1) setVal("countdownSuffixZone1", data.countdownSuffixZone1);
          if (data.countdownSuffixZone2) setVal("countdownSuffixZone2", data.countdownSuffixZone2);
          if (data.countdownSuffixZone3) setVal("countdownSuffixZone3", data.countdownSuffixZone3);
          setChecked("countdownShowUnitsZone0", !!data.countdownShowUnitsZone0);
          setChecked("countdownShowUnitsZone1", !!data.countdownShowUnitsZone1);
          setChecked("countdownShowUnitsZone2", !!data.countdownShowUnitsZone2);
          setChecked("countdownShowUnitsZone3", !!data.countdownShowUnitsZone3);
          setVal("charspacingZone0", data.charspacingZone0);
          setVal("charspacingZone1", data.charspacingZone1);
          setVal("charspacingZone2", data.charspacingZone2);
          setVal("charspacingZone3", data.charspacingZone3);
          setVal("deviceName", data.deviceName);
          setVal("ds18b20UpdateInterval", data.ds18b20UpdateInterval);
          setVal("ds18b20UnitsFormat", data.ds18b20UnitsFormat);

          setChecked("disableServiceMessages", data.disableServiceMessages);
          setChecked("disableDotsBlink", data.disableDotsBlink);
          setChecked("ds18b20Enable", data.ds18b20Enable);
          setText("ds18b20TempVal", data.ds18b20Temp);

          // Stock Ticker settings
          if (data.stockApiToken) setVal("stockApiToken", data.stockApiToken);
          if (data.stockUpdateInterval) setVal("stockUpdateInterval", data.stockUpdateInterval);
          if (data.stockSymbolsZone0) setVal("stockSymbolsZone0", data.stockSymbolsZone0);
          if (data.stockDisplayFormatZone0) setVal("stockDisplayFormatZone0", data.stockDisplayFormatZone0);
          if (data.stockPrefixZone0 !== undefined) setVal("stockPrefixZone0", data.stockPrefixZone0);
          if (data.stockPostfixZone0 !== undefined) setVal("stockPostfixZone0", data.stockPostfixZone0);
          if (data.stockSymbolsZone1) setVal("stockSymbolsZone1", data.stockSymbolsZone1);
          if (data.stockDisplayFormatZone1) setVal("stockDisplayFormatZone1", data.stockDisplayFormatZone1);
          if (data.stockPrefixZone1 !== undefined) setVal("stockPrefixZone1", data.stockPrefixZone1);
          if (data.stockPostfixZone1 !== undefined) setVal("stockPostfixZone1", data.stockPostfixZone1);
          if (data.stockSymbolsZone2) setVal("stockSymbolsZone2", data.stockSymbolsZone2);
          if (data.stockDisplayFormatZone2) setVal("stockDisplayFormatZone2", data.stockDisplayFormatZone2);
          if (data.stockPrefixZone2 !== undefined) setVal("stockPrefixZone2", data.stockPrefixZone2);
          if (data.stockPostfixZone2 !== undefined) setVal("stockPostfixZone2", data.stockPostfixZone2);
          if (data.stockSymbolsZone3) setVal("stockSymbolsZone3", data.stockSymbolsZone3);
          if (data.stockDisplayFormatZone3) setVal("stockDisplayFormatZone3", data.stockDisplayFormatZone3);
          if (data.stockPrefixZone3 !== undefined) setVal("stockPrefixZone3", data.stockPrefixZone3);
          if (data.stockPostfixZone3 !== undefined) setVal("stockPostfixZone3", data.stockPostfixZone3);

          // Populate Info section
          setText("firmwareVer", data.firmwareVer);
          setText("platform", data.platform);
          if (document.getElementById("footerFwVer")) setText("footerFwVer", data.firmwareVer);
          setText("wifiSsid", data.wifiSsid);
          setText("wifiIp", data.wifiIp);
          setText("wifiGateway", data.wifiGateway);
          setText("wifiRssi", data.wifiRssi + " dBm");
          setText("mqttDevicePrefixInfo", data.mqttDevicePrefix);
          setText("mqttDevicePrefixHelp", data.mqttDevicePrefix);
          setText("ds18b20TempInfo", data.ds18b20Temp);
        })
        .catch(err => {
          console.error('Error loading settings:', err);
        });
    }

    function preparePostRequest(event, key, val) {
      event.preventDefault(); //This will prevent the default click action
      if (key == "intensity") {
        document.getElementById('intensityValue').innerHTML = val;
        data = {
          key: "intensity",
          intensity: val
        }
        sendPost(data);
      }

      if (key == "displaySettings") {
        data = {
          key: "displaySettings",
          zoneNumbers: document.getElementById("zoneNumbers").value,
          zone0Begin: document.getElementById("zone0Begin").value,
          zone0End: document.getElementById("zone0End").value,
          zone1Begin: document.getElementById("zone1Begin").value,
          zone1End: document.getElementById("zone1End").value,
          zone2Begin: document.getElementById("zone2Begin").value,
          zone2End: document.getElementById("zone2End").value,
          zone3Begin: document.getElementById("zone3Begin").value,
          zone3End: document.getElementById("zone3End").value
        }
        sendPost(data);
      }

      if (key == "zone0Settings") {
        data = {
          key: "zoneSettings",
          zone: 0,
          workMode: document.getElementById("workModeZone0").value,
          font: document.getElementById("fontZone0").value,
          owmWhatToDisplay: document.getElementById("owmWhatToDisplayZone0").value,
          haSensorId: document.getElementById("haSensorIdZone0").value,
          haSensorPostfix: document.getElementById("haSensorPostfixZone0").value,
          clockDisplayFormat: document.getElementById("clockDisplayFormatZone0").value,
          scrollSpeed: document.getElementById("scrollSpeedZone0").value,
          scrollPause: document.getElementById("scrollPauseZone0").value,
          scrollAlign: document.getElementById("scrollAlignZone0").value,
          scrollEffectIn: document.getElementById("scrollEffectZone0In").value,
          scrollEffectOut: document.getElementById("scrollEffectZone0Out").value,
          charspacing: document.getElementById("charspacingZone0").value,
          mqttTextTopic: document.getElementById("mqttTextTopicZone0").value,
          mqttPostfix: document.getElementById("mqttPostfixZone0").value,
          scrollInfinite: document.getElementById("scrollInfiniteZone0").checked,
          ds18b20Postfix: document.getElementById("ds18b20PostfixZone0").value,
          stockSymbols: document.getElementById("stockSymbolsZone0").value,
          stockDisplayFormat: document.getElementById("stockDisplayFormatZone0").value,
          stockPrefix: document.getElementById("stockPrefixZone0").value,
          stockPostfix: document.getElementById("stockPostfixZone0").value,
          countdownTarget: document.getElementById("countdownTargetZone0").value,
          countdownFormat: document.getElementById("countdownFormatZone0").value,
          countdownFinish: document.getElementById("countdownFinishZone0").value,
          countdownShowUnits: document.getElementById("countdownShowUnitsZone0").checked,
          countdownPrefix: document.getElementById("countdownPrefixZone0").value,
          countdownSuffix: document.getElementById("countdownSuffixZone0").value

        }
        sendPost(data);
      }

      if (key == "zone1Settings") {
        data = {
          key: "zoneSettings",
          zone: 1,
          workMode: document.getElementById("workModeZone1").value,
          font: document.getElementById("fontZone1").value,
          owmWhatToDisplay: document.getElementById("owmWhatToDisplayZone1").value,
          haSensorId: document.getElementById("haSensorIdZone1").value,
          haSensorPostfix: document.getElementById("haSensorPostfixZone1").value,
          clockDisplayFormat: document.getElementById("clockDisplayFormatZone1").value,
          scrollSpeed: document.getElementById("scrollSpeedZone1").value,
          scrollPause: document.getElementById("scrollPauseZone1").value,
          scrollAlign: document.getElementById("scrollAlignZone1").value,
          scrollEffectIn: document.getElementById("scrollEffectZone1In").value,
          scrollEffectOut: document.getElementById("scrollEffectZone1Out").value,
          charspacing: document.getElementById("charspacingZone1").value,
          mqttTextTopic: document.getElementById("mqttTextTopicZone1").value,
          mqttPostfix: document.getElementById("mqttPostfixZone1").value,
          scrollInfinite: document.getElementById("scrollInfiniteZone1").checked,
          ds18b20Postfix: document.getElementById("ds18b20PostfixZone1").value,
          stockSymbols: document.getElementById("stockSymbolsZone1").value,
          stockDisplayFormat: document.getElementById("stockDisplayFormatZone1").value,
          stockPrefix: document.getElementById("stockPrefixZone1").value,
          stockPostfix: document.getElementById("stockPostfixZone1").value,
          countdownTarget: document.getElementById("countdownTargetZone1").value,
          countdownFormat: document.getElementById("countdownFormatZone1").value,
          countdownFinish: document.getElementById("countdownFinishZone1").value,
          countdownShowUnits: document.getElementById("countdownShowUnitsZone1").checked,
          countdownPrefix: document.getElementById("countdownPrefixZone1").value,
          countdownSuffix: document.getElementById("countdownSuffixZone1").value
        }
        sendPost(data);
      }

      if (key == "zone2Settings") {
        data = {
          key: "zoneSettings",
          zone: 2,
          workMode: document.getElementById("workModeZone2").value,
          font: document.getElementById("fontZone2").value,
          owmWhatToDisplay: document.getElementById("owmWhatToDisplayZone2").value,
          haSensorId: document.getElementById("haSensorIdZone2").value,
          haSensorPostfix: document.getElementById("haSensorPostfixZone2").value,
          clockDisplayFormat: document.getElementById("clockDisplayFormatZone2").value,
          scrollSpeed: document.getElementById("scrollSpeedZone2").value,
          scrollPause: document.getElementById("scrollPauseZone2").value,
          scrollAlign: document.getElementById("scrollAlignZone2").value,
          scrollEffectIn: document.getElementById("scrollEffectZone2In").value,
          scrollEffectOut: document.getElementById("scrollEffectZone2Out").value,
          charspacing: document.getElementById("charspacingZone2").value,
          mqttTextTopic: document.getElementById("mqttTextTopicZone2").value,
          mqttPostfix: document.getElementById("mqttPostfixZone2").value,
          scrollInfinite: document.getElementById("scrollInfiniteZone2").checked,
          ds18b20Postfix: document.getElementById("ds18b20PostfixZone2").value,
          stockSymbols: document.getElementById("stockSymbolsZone2").value,
          stockDisplayFormat: document.getElementById("stockDisplayFormatZone2").value,
          stockPrefix: document.getElementById("stockPrefixZone2").value,
          stockPostfix: document.getElementById("stockPostfixZone2").value,
          countdownTarget: document.getElementById("countdownTargetZone2").value,
          countdownFormat: document.getElementById("countdownFormatZone2").value,
          countdownFinish: document.getElementById("countdownFinishZone2").value,
          countdownShowUnits: document.getElementById("countdownShowUnitsZone2").checked,
          countdownPrefix: document.getElementById("countdownPrefixZone2").value,
          countdownSuffix: document.getElementById("countdownSuffixZone2").value
        }
        sendPost(data);
      }

      if (key == "zone3Settings") {
        data = {
          key: "zoneSettings",
          zone: 3,
          workMode: document.getElementById("workModeZone3").value,
          font: document.getElementById("fontZone3").value,
          owmWhatToDisplay: document.getElementById("owmWhatToDisplayZone3").value,
          haSensorId: document.getElementById("haSensorIdZone3").value,
          haSensorPostfix: document.getElementById("haSensorPostfixZone3").value,
          clockDisplayFormat: document.getElementById("clockDisplayFormatZone3").value,
          scrollSpeed: document.getElementById("scrollSpeedZone3").value,
          scrollPause: document.getElementById("scrollPauseZone3").value,
          scrollAlign: document.getElementById("scrollAlignZone3").value,
          scrollEffectIn: document.getElementById("scrollEffectZone3In").value,
          scrollEffectOut: document.getElementById("scrollEffectZone3Out").value,
          charspacing: document.getElementById("charspacingZone3").value,
          mqttTextTopic: document.getElementById("mqttTextTopicZone3").value,
          mqttPostfix: document.getElementById("mqttPostfixZone3").value,
          scrollInfinite: document.getElementById("scrollInfiniteZone3").checked,
          ds18b20Postfix: document.getElementById("ds18b20PostfixZone3").value,
          stockSymbols: document.getElementById("stockSymbolsZone3").value,
          stockDisplayFormat: document.getElementById("stockDisplayFormatZone3").value,
          stockPrefix: document.getElementById("stockPrefixZone3").value,
          stockPostfix: document.getElementById("stockPostfixZone3").value,
          countdownTarget: document.getElementById("countdownTargetZone3").value,
          countdownFormat: document.getElementById("countdownFormatZone3").value,
          countdownFinish: document.getElementById("countdownFinishZone3").value,
          countdownShowUnits: document.getElementById("countdownShowUnitsZone3").checked,
          countdownPrefix: document.getElementById("countdownPrefixZone3").value,
          countdownSuffix: document.getElementById("countdownSuffixZone3").value
        }
        sendPost(data);
      }


      if (key == "applyMqttSettings") {
        data = {
          key: "mqttSettings",
          mqttEnable: document.querySelector("#mqttEnable").checked,
          mqttServerAddress: document.getElementById("mqttServerAddress").value,
          mqttServerPort: document.getElementById("mqttServerPort").value,
          mqttUsername: document.getElementById("mqttUsername").value,
          mqttPassword: document.getElementById("mqttPassword").value
        }
        sendPost(data);
      }

      if (key == "applyWallClockSettings") {
        data = {
          key: "wallClockSett",
          ntpTimeZone: document.getElementById("ntpTimeZone").value,
          disableDotsBlink: document.querySelector('#disableDotsBlink').checked,
          ntpUpdateInterval: document.getElementById("ntpUpdateInterval").value,
          ntpServer: document.getElementById("ntpServer").value
        }
        sendPost(data);
      }

      if (key == "applyOwmSettings") {
        data = {
          key: "owmSettings",
          owmApiToken: document.getElementById("owmApiToken").value,
          owmUnitsFormat: document.getElementById("owmUnitsFormat").value,
          owmUpdateInterval: document.getElementById("owmUpdateInterval").value,
          owmCity: document.getElementById("owmCity").value
        }
        sendPost(data);
      }

      if (key == "applyHaSettings") {
        data = {
          key: "haSettings",
          haAddr: document.getElementById("haAddr").value,
          haApiToken: document.getElementById("haApiToken").value,
          haApiHttpType: document.getElementById("haApiHttpType").value,
          haApiPort: document.getElementById("haApiPort").value,
          haUpdateInterval: document.getElementById("haUpdateInterval").value
        }
        sendPost(data);
      }

      if (key == "applySystemSettings") {
        data = {
          key: "systemSettings",
          deviceName: document.getElementById("deviceName").value,
          disableServiceMessages: document.querySelector('#disableServiceMessages').checked
        }
        sendPost(data);
      }
      if (key == "applyDs18b20Settings") {
        data = {
          key: "ds18b20Settings",
          ds18b20Enable: document.querySelector('#ds18b20Enable').checked,
          ds18b20UpdateInterval: document.querySelector('#ds18b20UpdateInterval').value,
          ds18b20UnitsFormat: document.querySelector('#ds18b20UnitsFormat').value
        }
        sendPost(data);
      }
      if (key == "applyStockSettings") {
        data = {
          key: "stockSettings",
          stockApiToken: document.getElementById('stockApiToken').value,
          stockUpdateInterval: document.getElementById('stockUpdateInterval').value
        }
        sendPost(data);
      }


    };

    function sendPost(dataPost, retryCount) {
      retryCount = retryCount || 0;
      var toastDanger = new bootstrap.Toast(document.getElementById('liveToastDanger'));
      var toastSuccess = new bootstrap.Toast(document.getElementById('liveToastSuccess'));

      var request = $.ajax({
        url: "/api/config",
        method: "POST",
        cache: false,
        data: dataPost,
        dataType: "json"
      });

      request.done(function (msg) {
        toastSuccess.show();
      });

      request.fail(function (jqXHR, textStatus, responseText) {
        if (jqXHR.status === 503 && retryCount < 2) {
          var toastBusy = new bootstrap.Toast(document.getElementById('liveToastBusy'));
          toastBusy.show();
          console.log("Device busy, retry " + (retryCount + 1) + "/3 in 2s...");
          setTimeout(function () { sendPost(dataPost, retryCount + 1); }, 2000);
        } else {
          if (jqXHR.status === 503) {
            alert("Device busy after 3 attempts. Please try again later.");
          } else {
            alert("Request failed: " + responseText);
          }
          toastDanger.show();
        }
      });
    }
    function apiResetWifi() {
      if (confirm("This will reset WiFi settings and reboot. You will need to connect to the AP to reconfigure. Are you sure?")) {
        var request = $.ajax({
          url: "/api/resetWifi",
          method: "POST",
          cache: false
        });
        request.done(function (msg) {
          // alert("Device is resetting WiFi...");
        });
        request.fail(function (jqXHR, textStatus) {
          alert("Request failed: " + textStatus);
        });
      }
    }
    function apiRebootDevice() {
      if (confirm("Are you sure you want to reboot the device?")) {
        var request = $.ajax({
          url: "/api/reboot",
          method: "POST",
          cache: false
        });
        request.done(function (msg) {
          // alert("Device is rebooting...");
        });
        request.fail(function (jqXHR, textStatus) {
          alert("Request failed: " + textStatus);
        });
      }
    }
    function apiFactoryReset() {
      if (confirm("WARNING: This will erase ALL settings (WiFi, MQTT, zones, etc.) and reboot. Are you absolutely sure?")) {
        var request = $.ajax({
          url: "/api/factory-reset",
          method: "POST",
          cache: false
        });
        request.done(function (msg) {
          alert("Factory reset complete. Device is rebooting...");
        });
        request.fail(function (jqXHR, textStatus) {
          alert("Request failed: " + textStatus);
        });
      }
    }
  </script>

</body>

</html>